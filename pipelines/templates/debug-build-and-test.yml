steps:
  - task: Bash@3
    displayName: Install Emulator
    inputs:
      filePath: 'pipelines/templates/android-emulator-install.sh'
    condition: succeededOrFailed()

  - template: buildSrc.yml

  - task: Gradle@2
    displayName: Build Debug APK
    inputs:
      tasks: 'assembleDebug'
      gradleWrapperFile: 'gradlew'
      publishJUnitResults: false
    condition: succeededOrFailed()

  - task: Bash@3
    displayName: Start Emulator
    inputs:
      filePath: 'pipelines/templates/android-emulator-start.sh'
    condition: succeededOrFailed()

  - task: Gradle@2
    displayName: Build Test APK
    inputs:
      tasks: 'assembleAndroidTest'
      gradleWrapperFile: 'gradlew'
      publishJUnitResults: false
    condition: succeededOrFailed()

  - template: unit-tests-android.yml
    parameters:
      param: ["app"]

  - template: unit-tests-kotlin.yml
    parameters:
      param: ["core-data-network"]

  - task: Gradle@2
    displayName: Check Android Issues
    continueOnError: true
    inputs:
      tasks: 'lintDebug'
      gradleWrapperFile: 'gradlew'
      publishJUnitResults: false
    condition: succeededOrFailed()

  - template: ktlint.yml

  - task: Bash@3
    displayName: Wait for Emulator
    inputs:
      filePath: 'pipelines/templates/android-emulator-wait.sh'
    condition: succeededOrFailed()

  - task: Gradle@2
    displayName: Run Android Tests
    inputs:
      tasks: 'connectedCheck'
      gradleWrapperFile: 'gradlew'
      publishJUnitResults: true
      testResultsFiles: '**/TEST-*-.xml'
      testRunTitle: 'Android Tests'
    condition: succeededOrFailed()

  - task: Gradle@2
    displayName: Create Coverage Report
    inputs:
      tasks: 'jacocoTestReportMerge'
      gradleWrapperFile: 'gradlew'
      publishJUnitResults: false
    condition: succeededOrFailed()

  - task: Bash@3
    displayName: Collect Sources
    inputs:
      filePath: 'pipelines/templates/collect-sources.sh'
    condition: succeededOrFailed()

  - task: PublishCodeCoverageResults@1
    displayName: Report Coverage
    inputs:
      codeCoverageTool: 'JaCoCo'
      summaryFileLocation: 'build/reports/jacoco/merged/jacocoTestReport.xml'
      pathToSources: 'build/coverage/sources'
      failIfCoverageEmpty: true
    condition: succeededOrFailed()

  - task: PublishPipelineArtifact@1
    displayName: Publish Test Reports
    inputs:
      targetPath: 'app/build/reports'
      artifactName: 'Test Reports'
    condition: succeededOrFailed()